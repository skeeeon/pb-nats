# PocketBase NATS Sync

A library for seamless integration between [PocketBase](https://pocketbase.io/) and [NATS Server](https://nats.io/) that automatically generates and updates NATS authentication configuration in real-time.

## Features

- 🔄 **Real-time Sync**: Automatically updates NATS configuration when user or role data changes in PocketBase
- 🔐 **Secure Authentication**: Properly formats bcrypt passwords and permissions for NATS authentication
- ⚡ **Event-Driven**: Uses PocketBase hooks for efficient, event-driven updates
- 🛡️ **Atomic Updates**: Ensures config files are updated atomically with proper backups
- ⏱️ **Smart Debouncing**: Prevents excessive NATS reloads when multiple changes occur
- 🔧 **Highly Configurable**: Customize collections, file paths, permissions, and more
- 🧠 **Intelligent Caching**: Avoids unnecessary file writes when content hasn't changed

## Installation

```bash
go get github.com/skeeeon/pb-nats
```

## Quick Start

Integrating NATS synchronization into your PocketBase application is simple:

```go
package main

import (
    "log"
    "github.com/pocketbase/pocketbase"
    "github.com/skeeeon/pb-nats"
)

func main() {
    // Initialize PocketBase
    app := pocketbase.New()
    
    // Setup NATS integration with default options
    if err := pbnats.Setup(app, pbnats.DefaultOptions()); err != nil {
        log.Fatalf("Failed to setup NATS sync: %v", err)
    }
    
    // Start the PocketBase app as usual
    if err := app.Start(); err != nil {
        log.Fatal(err)
    }
}
```

## PocketBase Collection Schema

The library expects the following collections in your PocketBase instance:

### nats_users Collection

Create a collection with the following fields:

| Field | Type | Description |
|-------|------|-------------|
| `username` | Text | username |
| `password` | Text | Bcrypt hashed password |
| `role_id` | Relation | Reference to the nats_roles collection |
| `active` | Boolean | Whether the user is active |

### nats_roles Collection

Create a collection with the following fields:

| Field | Type | Description |
|-------|------|-------------|
| `name` | Text | Role name |
| `publish_permissions` | JSON | Array of publish topic patterns |
| `subscribe_permissions` | JSON | Array of subscribe topic patterns |

For the permission fields, use the JSON field type in PocketBase and store values as properly formatted JSON arrays:

```json
["acme.bld-na-001.reader.*.event", "acme.bld-na-001.sensor.*.telemetry"]
```

## Configuration Options

You can customize the library's behavior using the `Options` struct:

```go
options := pbnats.DefaultOptions()

// Custom collection names (defaults are "nats_users" and "nats_roles")
options.UserCollectionName = "my_users"
options.RoleCollectionName = "my_roles"

// Custom file paths
options.ConfigFilePath = "/etc/nats/auth.conf"
options.BackupDirPath = "/var/backups/nats"

// Custom reload command
options.ReloadCommand = "systemctl reload nats-server"

// Debounce interval (wait time after changes before updating)
options.DebounceInterval = 5 * time.Second

// Custom permissions
options.DefaultPublish = "PUBLIC.>"
options.DefaultSubscribe = []string{"PUBLIC.>", "_INBOX.>"}

// Custom event filtering
options.EventFilter = func(collectionName, eventType string) bool {
    // Only process certain events
    return true
}

// Backup settings
options.CreateBackups = true
options.MaxBackups = 20 // Keep last 20 backup files

// Initial config generation
options.GenerateInitialConfig = true

// Apply the configuration
if err := pbnats.Setup(app, options); err != nil {
    log.Fatalf("Failed to setup NATS sync: %v", err)
}
```

## How It Works

The library works by:

1. Registering hooks on the user and role collections in PocketBase
2. When records are created, updated, or deleted, it schedules a sync operation with debouncing
3. After the debounce period, it generates a new NATS configuration based on the current state
4. If the configuration has changed, it writes it to the file atomically and reloads NATS

### Generated NATS Configuration

The generated configuration follows this format:

```
# Authentication Configuration
# Auto-generated by pb-nats
# Generated at: 2025-05-11T12:34:56Z

authorization {
  # Default permissions applied to all users
  default_permissions = {
    publish = "PUBLIC.>"
    subscribe = ["PUBLIC.>", "_INBOX.>"]
  }

  # Role definitions
  ADMIN = {
    publish = ">"
    subscribe = ">"
  }
  READER = {
    publish = ["acme.bld-na-001.reader.*.event"]
    subscribe = ["acme.bld-na-001.reader.>"]
  }

  # User definitions
  users = [
    {user: "admin", password: "$2a$10$XXX...", permissions: $ADMIN},
    {user: "reader1", password: "$2a$10$YYY...", permissions: $READER}
  ]
}
```

## Event Types

The library defines the following event types for filtering:

- `user_create`: User record created
- `user_update`: User record updated
- `user_delete`: User record deleted
- `role_create`: Role record created
- `role_update`: Role record updated
- `role_delete`: Role record deleted

## Advanced Usage

### Custom Event Filtering

You can implement custom filtering logic:

```go
options.EventFilter = func(collectionName, eventType string) bool {
    // Skip sync for user deletion events
    if eventType == pbnats.EventTypeUserDelete {
        return false
    }
    
    // Process all other events
    return true
}
```

### Custom Directory Structure

Configure custom paths for the configuration files:

```go
options.ConfigFilePath = "/path/to/auth.conf"
options.BackupDirPath = "/path/to/backups"
```

### Custom Default Permissions

Set custom default permissions:

```go
// String format
options.DefaultPublish = "clients.>"

// Array format
options.DefaultSubscribe = []string{"clients.>", "public.>"}
```

## Security Considerations

1. **Password Storage**: Store passwords as bcrypt hashes in PocketBase
2. **File Permissions**: The library ensures the config file has restrictive permissions (0644)
3. **Backup Management**: Old backups are automatically cleaned up to prevent disk space issues
4. **Atomic Updates**: Configuration updates use atomic operations to prevent partial writes

## Error Handling

The library handles errors gracefully and provides detailed logging when enabled.
Common scenarios handled include:

- Missing or invalid collection names
- Permission issues with file operations
- NATS reload command failures
- Concurrent update attempts

## License

MIT License - See LICENSE file for details.# pb-nats
